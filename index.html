<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disc Golf Putting Tracker</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRGlzYyBHb2xmIFB1dHRpbmcgVHJhY2tlciIsInNob3J0X25hbWUiOiJQdXR0aW5nIFRyYWNrZXIiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiM2NjdlZWEiLCJ0aGVtZV9jb2xvciI6IiMyRThCNTciLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCMmFXVjNRbTk0UFNJd0lEQWdOVEV5SURVeE1pSWdlRzFzYm5NOUltaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6SXdNREF2YzNabklpQkdkbTlqYTJOdmJHOXlQU0k5SWo0OGNtVmpkQ0JtYVd4c1BTSWpOelZrWW1FbElpQjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJdlBqeDBaWGgwSUdacGJHdzlJaU5tWm1ZaUlIZzlRak0xSXlSemNHRnVJSGc5SWpFME1pSWdlVDBpTXprd0lpSWdabTl1ZEMxemFYcGxQU0kwTUNJK1BIUjBjWEJoYmtSeVBWeDRNa005SWtacGNtVk1hV3hsVDFKa1pYSXFQand2ZEhkNGRHRnVQand2ZEhSNGRHRnVQand2ZEhSNGRHRnVQand2YzNabkBgIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <meta name="theme-color" content="#2E8B57">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Putting Tracker">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2E8B57, #3CB371);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .sync-status {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
        }

        .sync-status.online {
            background: rgba(76, 175, 80, 0.8);
        }

        .sync-status.offline {
            background: rgba(255, 152, 0, 0.8);
        }

        .sync-status.syncing {
            background: rgba(33, 150, 243, 0.8);
        }

        .refresh-btn {
            position: absolute;
            top: 10px;
            left: 15px;
            font-size: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
        }

        .install-prompt {
            background: #2196F3;
            color: white;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            display: none;
        }

        .setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .setup-modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            text-align: center;
        }

        .setup-modal h2 {
            color: #2E8B57;
            margin-bottom: 20px;
        }

        .setup-modal input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .setup-modal button {
            width: 100%;
            padding: 12px;
            background: #2E8B57;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .user-selector {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-selector select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .add-user-btn {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Tab Navigation */
        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #2E8B57;
            border-bottom: 3px solid #2E8B57;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .content {
            padding: 30px 20px;
        }

        .setup-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .setup-section h3 {
            color: #2E8B57;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .distance-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .distance-select-btn {
            padding: 15px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .distance-select-btn.selected {
            background: #2E8B57;
            color: white;
            border-color: #2E8B57;
        }

        .distance-select-btn:hover {
            border-color: #2E8B57;
        }

        .set-button {
            width: 100%;
            padding: 12px;
            background: #2E8B57;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .set-button:hover {
            background: #236B47;
        }

        .set-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .current-session {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2E8B57;
            margin-bottom: 20px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .session-info span {
            font-weight: 600;
            color: #2E8B57;
        }

        .quick-log {
            margin-bottom: 30px;
        }

        .quick-log h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .makes-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .makes-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        .log-set-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .log-set-btn:hover {
            transform: translateY(-2px);
        }

        .log-set-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .stats h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .end-session-btn {
            width: 100%;
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .end-session-btn:hover {
            background: #c82333;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #f5c6cb;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-btn {
            padding: 8px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .preset-btn:hover {
            background: #5a6268;
        }

        /* Dashboard Styles */
        .dashboard {
            padding: 20px;
        }

        .distance-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .distance-btn {
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .distance-btn.active {
            background: #2E8B57;
        }

        .distance-btn:hover {
            opacity: 0.8;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        .session-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .session-item {
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .session-header {
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-header:hover {
            background: #f8f9fa;
        }

        .session-info-dash {
            flex: 1;
        }

        .session-date {
            font-size: 12px;
            color: #6c757d;
        }

        .session-details {
            font-weight: 600;
            color: #333;
            margin-top: 4px;
        }

        .expand-icon {
            font-size: 12px;
            color: #6c757d;
            transition: transform 0.3s;
        }

        .session-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .session-sets {
            padding: 0 12px 12px 12px;
            display: none;
        }

        .session-item.expanded .session-sets {
            display: block;
        }

        .set-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 6px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .set-number {
            color: #6c757d;
            font-weight: 600;
        }

        .set-result {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .offline-data-indicator {
            background: #fff3cd;
            color: #856404;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #ffeaa7;
        }

        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .confirm-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 300px;
            width: 90%;
            text-align: center;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .confirm-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm-yes {
            background: #dc3545;
            color: white;
        }

        .confirm-no {
            background: #6c757d;
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2E8B57;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Checking for updates...</p>
        </div>
    </div>

    <!-- Setup Overlay -->
    <div id="setupOverlay" class="setup-overlay">
        <div class="setup-modal">
            <h2>🥏 Setup Your Tracker</h2>
            <p style="margin-bottom: 20px; color: #666;">Enter your Airtable credentials to get started:</p>
            <input type="text" id="setupToken" placeholder="Personal Access Token" />
            <input type="text" id="setupBaseId" placeholder="Base ID (app...)" />
            <input type="text" id="setupTableName" placeholder="Table Name" />
            <button id="saveSetupBtn">Save & Continue</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <h3>End Session?</h3>
            <p style="color: #666; margin-top: 10px;">Are you sure you want to end this session?</p>
            <div class="confirm-buttons">
                <button class="confirm-yes" id="confirmEndBtn">Yes, End Session</button>
                <button class="confirm-no" id="cancelEndBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="refresh-btn" id="refreshBtn" title="Refresh App">↻</button>
            <h1>🥏 Putting Tracker</h1>
            <p>It's not the putter, it's the putter</p>
            <div id="syncStatus" class="sync-status online">●</div>
        </div>
        
        <div id="installPrompt" class="install-prompt">
            📱 Install this app for better experience! Tap here.
        </div>
        
        <!-- User Selector -->
        <div class="user-selector">
            <label style="font-weight: 600; color: #333;">User:</label>
            <select id="userSelect">
                <option value="">Select User</option>
            </select>
            <button class="add-user-btn" id="addUserBtn">+ Add User</button>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-container">
            <button class="tab active" data-tab="logging">Log Putts</button>
            <button class="tab" data-tab="dashboard">Dashboard</button>
        </div>
        
        <!-- Logging Tab Content -->
        <div id="logging" class="tab-content active">
            <div class="content">
                <div id="offlineIndicator" class="offline-data-indicator hidden">
                    📡 Offline mode - data will sync when online
                </div>
                
                <!-- Setup Section - Only visible when no session is active -->
                <div id="setupSection" class="setup-section">
                    <h3>Session Setup</h3>
                    <div class="input-group">
                        <label>Distance (feet)</label>
                        <div class="distance-selector">
                            <button class="distance-select-btn" data-distance="10">10 ft</button>
                            <button class="distance-select-btn" data-distance="15">15 ft</button>
                            <button class="distance-select-btn" data-distance="20">20 ft</button>
                            <button class="distance-select-btn" data-distance="25">25 ft</button>
                            <button class="distance-select-btn" data-distance="30">30 ft</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="puttsPerSet">Putts per Set</label>
                        <input type="number" id="puttsPerSet" placeholder="5" min="1" max="20">
                    </div>
                    <button class="set-button" id="startSessionBtn" disabled>Start Session</button>
                </div>

                <!-- Active Session Content - Only visible during active session -->
                <div id="activeSessionContent" class="hidden">
                    <!-- Current Session Display -->
                    <div id="currentSession" class="current-session">
                        <div class="session-info">
                            <span>Distance: <span id="currentDistance"></span> ft</span>
                            <span>Per Set: <span id="currentPutts"></span> putts</span>
                        </div>
                        <div class="session-info">
                            <span>User: <span id="currentUser"></span></span>
                        </div>
                    </div>

                    <!-- Success/Error Messages -->
                    <div id="messageArea"></div>

                    <!-- Quick Logging Section -->
                    <div id="quickLogSection" class="quick-log">
                        <h3>Log Makes</h3>
                        
                        <!-- Preset Buttons -->
                        <div class="preset-buttons" id="presetButtons">
                            <!-- Buttons will be dynamically generated -->
                        </div>
                        
                        <div class="makes-input">
                            <input type="number" id="makes" placeholder="0" min="0" max="20">
                            <button class="log-set-btn" id="logSetBtn">Log Set</button>
                        </div>
                    </div>

                    <!-- Session Stats -->
                    <div id="sessionStats" class="stats">
                        <h4>Session Stats</h4>
                        <div class="stat-row">
                            <span>Sets Logged:</span>
                            <span id="setsCount">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Total Attempts:</span>
                            <span id="totalAttempts">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Total Makes:</span>
                            <span id="totalMakes">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Session Average:</span>
                            <span id="sessionAverage">0%</span>
                        </div>
                    </div>

                    <!-- End Session Button -->
                    <button class="end-session-btn" id="endSessionBtn">End Session</button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab Content -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard">
                <h3>Putting Analytics</h3>
                
                <!-- Distance Selector -->
                <div class="distance-selector">
                    <h4>Select Distance:</h4>
                    <div class="distance-buttons" id="distanceButtons">
                        <button class="distance-btn" data-distance="10">10ft</button>
                        <button class="distance-btn active" data-distance="15">15ft</button>
                        <button class="distance-btn" data-distance="20">20ft</button>
                        <button class="distance-btn" data-distance="25">25ft</button>
                        <button class="distance-btn" data-distance="30">30ft</button>
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="chart-container">
                    <div class="chart-title" id="chartTitle">15ft Putting Progress</div>
                    <div id="chartContent">
                        <div class="loading">Loading data...</div>
                    </div>
                </div>

                <!-- Session Summary -->
                <div class="session-list">
                    <h4>Recent Sessions</h4>
                    <div id="sessionSummary">
                        <div class="loading">Loading sessions...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let AIRTABLE_CONFIG = {
            token: '',
            baseId: '',
            tableName: ''
        };

        let selectedDistance = 15;
        let selectedSetupDistance = null;
        let dashboardData = [];
        let isOnline = navigator.onLine;
        let deferredPrompt;
        let currentUser = '';
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        let expandedSessions = new Set();

        let currentSessionData = {
            distance: 0,
            puttsPerSet: 0,
            sessionId: '',
            sets: [],
            isActive: false
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-refresh on launch
            forceRefresh();
            
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                checkSetup();
                loadUsers();
                updateOnlineStatus();
                setupEventListeners();
                
                document.getElementById('puttsPerSet').value = '5';
            }, 1500); // Small delay for refresh
        });

        // Force refresh function
        function forceRefresh() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                location.reload(true);
            });
            
            // Setup button
            document.getElementById('saveSetupBtn').addEventListener('click', saveSetup);
            
            // User management
            document.getElementById('userSelect').addEventListener('change', switchUser);
            document.getElementById('addUserBtn').addEventListener('click', addNewUser);
            
            // Tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    showTab(this.dataset.tab);
                });
            });
            
            // Distance selection for setup
            document.querySelectorAll('.distance-select-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectSetupDistance(parseInt(this.dataset.distance));
                });
            });
            
            // Session management
            document.getElementById('startSessionBtn').addEventListener('click', startSession);
            document.getElementById('logSetBtn').addEventListener('click', logSet);
            document.getElementById('endSessionBtn').addEventListener('click', showEndSessionConfirm);
            
            // Confirmation modal
            document.getElementById('confirmEndBtn').addEventListener('click', confirmEndSession);
            document.getElementById('cancelEndBtn').addEventListener('click', cancelEndSession);
            
            // Dashboard distance buttons
            document.querySelectorAll('.distance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectDistance(parseInt(this.dataset.distance));
                });
            });
            
            // Install prompt
            document.getElementById('installPrompt').addEventListener('click', handleInstallPrompt);
            
            // Keyboard shortcuts
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (!currentSessionData.isActive) {
                        startSession();
                    } else {
                        logSet();
                    }
                }
            });
        }

        // Setup and Configuration
        function checkSetup() {
            const savedConfig = localStorage.getItem('airtableConfig');
            if (savedConfig) {
                AIRTABLE_CONFIG = JSON.parse(savedConfig);
                document.getElementById('setupOverlay').style.display = 'none';
            }
        }

        function saveSetup() {
            const token = document.getElementById('setupToken').value.trim();
            const baseId = document.getElementById('setupBaseId').value.trim();
            const tableName = document.getElementById('setupTableName').value.trim();

            if (!token || !baseId || !tableName) {
                alert('Please fill in all fields');
                return;
            }

            AIRTABLE_CONFIG = { token, baseId, tableName };
            localStorage.setItem('airtableConfig', JSON.stringify(AIRTABLE_CONFIG));
            document.getElementById('setupOverlay').style.display = 'none';
        }

        // User Management
        function loadUsers() {
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">Select User</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });

            // Load saved user
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && users.includes(savedUser)) {
                userSelect.value = savedUser;
                currentUser = savedUser;
            }
        }

        function switchUser() {
            const selectedUser = document.getElementById('userSelect').value;
            if (selectedUser) {
                currentUser = selectedUser;
                localStorage.setItem('currentUser', selectedUser);
                showMessage(`Switched to user: ${selectedUser}`, 'success');
                
                // Refresh dashboard if it's active
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadDashboardData();
                }
            }
        }

        function addNewUser() {
            const userName = prompt('Enter new user name:');
            if (userName && userName.trim()) {
                const trimmedName = userName.trim();
                if (!users.includes(trimmedName)) {
                    users.push(trimmedName);
                    localStorage.setItem('users', JSON.stringify(users));
                    loadUsers();
                    document.getElementById('userSelect').value = trimmedName;
                    switchUser();
                    showMessage(`Added new user: ${trimmedName}`, 'success');
                } else {
                    showMessage('User already exists', 'error');
                }
            }
        }

        // Distance selection for setup
        function selectSetupDistance(distance) {
            selectedSetupDistance = distance;
            
            document.querySelectorAll('.distance-select-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.distance) === distance) {
                    btn.classList.add('selected');
                }
            });
            
            // Enable start button if distance is selected
            checkStartButtonState();
        }

        function checkStartButtonState() {
            const startBtn = document.getElementById('startSessionBtn');
            const puttsPerSet = document.getElementById('puttsPerSet').value;
            
            if (selectedSetupDistance && puttsPerSet && currentUser) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }

        // Add event listener for putts per set input
        document.getElementById('puttsPerSet')?.addEventListener('input', checkStartButtonState);

        // Generate auto Session ID
        function generateSessionId() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
            return `${currentUser}_${dateStr}_${timeStr}`;
        }

        // PWA Install functionality
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        async function handleInstallPrompt() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installPrompt').style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdkaXNjLWdvbGYtcHV0dGluZy12Mic7DQpjb25zdCB1cmxzVG9DYWNoZSA9IFsNCiAgJy4vJywNCiAgJy4vaW5kZXguaHRtbCcNCl07DQoNCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignaW5zdGFsbCcsIGV2ZW50ID0+IHsNCiAgZXZlbnQud2FpdFVudGlsKA0KICAgIGNhY2hlcy5vcGVuKENBQ0hFX05BTUUpDQogICAgICAudGhlbihjYWNoZSA9PiBjYWNoZS5hZGRBbGwodXJsc1RvQ2FjaGUpKQ0KICApOw0KfSk7DQoNCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBldmVudCA9PiB7DQogIGV2ZW50LnJlc3BvbmRXaXRoKA0KICAgIGNhY2hlcy5tYXRjaChldmVudC5yZXF1ZXN0KQ0KICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gew0KICAgICAgICBpZiAocmVzcG9uc2UpIHsNCiAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZldGNoKGV2ZW50LnJlcXVlc3QpOw0KICAgICAgfSkNCiAgKTsNCn0pOw==')
              .then(() => console.log('Service Worker registered'))
              .catch(err => console.log('Service Worker registration failed'));
        }

        // Online/Offline Detection
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusEl = document.getElementById('syncStatus');
            const offlineIndicator = document.getElementById('offlineIndicator');
            
            if (isOnline) {
                statusEl.textContent = '●';
                statusEl.className = 'sync-status online';
                statusEl.title = 'Online';
                offlineIndicator.classList.add('hidden');
                syncOfflineData();
            } else {
                statusEl.textContent = '●';
                statusEl.className = 'sync-status offline';
                statusEl.title = 'Offline';
                offlineIndicator.classList.remove('hidden');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Offline Data Management
        function saveOfflineData(record) {
            const offlineData = JSON.parse(localStorage.getItem('offlineData') || '[]');
            offlineData.push({
                ...record,
                timestamp: Date.now(),
                id: Math.random().toString(36).substr(2, 9)
            });
            localStorage.setItem('offlineData', JSON.stringify(offlineData));
        }

        function getOfflineData() {
            return JSON.parse(localStorage.getItem('offlineData') || '[]');
        }

        function clearOfflineData() {
            localStorage.removeItem('offlineData');
        }

        async function syncOfflineData() {
            const offlineData = getOfflineData();
            if (offlineData.length === 0) return;

            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = '↻';
            statusEl.className = 'sync-status syncing';
            statusEl.title = 'Syncing...';

            try {
                for (const record of offlineData) {
                    const { id, timestamp, ...cleanRecord } = record;
                    await saveToAirtable(cleanRecord);
                }
                clearOfflineData();
                statusEl.textContent = '●';
                statusEl.className = 'sync-status online';
                statusEl.title = 'Synced';
                showMessage(`Synced ${offlineData.length} offline records!`, 'success');
            } catch (error) {
                console.error('Sync failed:', error);
                statusEl.textContent = '●';
                statusEl.className = 'sync-status offline';
                statusEl.title = 'Sync failed';
            }
        }

        // Tab switching functionality
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') {
                loadDashboardData();
            }
        }

        // Distance selection for dashboard
        function selectDistance(distance) {
            selectedDistance = distance;
            
            document.querySelectorAll('.distance-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.distance) === distance) {
                    btn.classList.add('active');
                }
            });
            
            updateChart();
            updateSessions();
        }

        // Load data from Airtable for dashboard (filtered by current user)
        async function loadDashboardData() {
            if (!currentUser) {
                document.getElementById('chartContent').innerHTML = '<div class="no-data">Please select a user first</div>';
                document.getElementById('sessionSummary').innerHTML = '<div class="no-data">Please select a user first</div>';
                return;
            }

            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}?filterByFormula={User}="${currentUser}"`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const data = await response.json();
                dashboardData = data.records.map(record => ({
                    date: record.fields.Date,
                    distance: record.fields.Distance,
                    puttsPerSet: record.fields['Putts Per Set'],
                    makes: record.fields.Makes,
                    percentage: record.fields['Make Percentage'] || (record.fields.Makes / record.fields['Putts Per Set'] * 100),
                    sessionId: record.fields['Session ID'],
                    user: record.fields.User
                }));

                updateChart();
                updateSessions();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('chartContent').innerHTML = '<div class="no-data">Error loading data</div>';
                document.getElementById('sessionSummary').innerHTML = '<div class="no-data">Error loading sessions</div>';
            }
        }

        // Update chart for selected distance
        function updateChart() {
            const distanceData = dashboardData.filter(d => d.distance === selectedDistance);
            
            document.getElementById('chartTitle').textContent = `${selectedDistance}ft Putting Progress`;
            
            if (distanceData.length === 0) {
                document.getElementById('chartContent').innerHTML = '<div class="no-data">No data for this distance yet</div>';
                return;
            }

            const sessionAverages = {};
            distanceData.forEach(record => {
                if (!sessionAverages[record.sessionId]) {
                    sessionAverages[record.sessionId] = {
                        date: record.date,
                        totalMakes: 0,
                        totalAttempts: 0,
                        sessionId: record.sessionId
                    };
                }
                sessionAverages[record.sessionId].totalMakes += record.makes;
                sessionAverages[record.sessionId].totalAttempts += record.puttsPerSet;
            });

            const chartData = Object.values(sessionAverages).map(session => ({
                date: session.date,
                percentage: (session.totalMakes / session.totalAttempts * 100).toFixed(1),
                sessionId: session.sessionId
            })).sort((a, b) => new Date(a.date) - new Date(b.date));

            const chartHeight = 150;
            const chartWidth = 300;
            
            let chartHTML = `
                <div style="position: relative; width: ${chartWidth}px; height: ${chartHeight + 40}px; margin: 0 auto;">
                    <svg width="${chartWidth}" height="${chartHeight + 40}" style="overflow: visible;">
                        <defs>
                            <pattern id="grid" width="20" height="15" patternUnits="userSpaceOnUse">
                                <path d="M 20 0 L 0 0 0 15" fill="none" stroke="#e0e0e0" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="${chartWidth}" height="${chartHeight}" fill="url(#grid)" />
                        
                        <text x="-5" y="15" text-anchor="end" font-size="10" fill="#666">100%</text>
                        <text x="-5" y="${chartHeight/2 + 15}" text-anchor="end" font-size="10" fill="#666">50%</text>
                        <text x="-5" y="${chartHeight + 15}" text-anchor="end" font-size="10" fill="#666">0%</text>
                        
                        <polyline
                            fill="none"
                            stroke="#2E8B57"
                            stroke-width="3"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            points="${chartData.map((point, index) => {
                                const x = (index / Math.max(chartData.length - 1, 1)) * (chartWidth - 20) + 10;
                                const y = chartHeight - (parseFloat(point.percentage) / 100) * chartHeight;
                                return `${x},${y}`;
                            }).join(' ')}"
                        />
                        
                        ${chartData.map((point, index) => {
                            const x = (index / Math.max(chartData.length - 1, 1)) * (chartWidth - 20) + 10;
                            const y = chartHeight - (parseFloat(point.percentage) / 100) * chartHeight;
                            return `
                                <circle cx="${x}" cy="${y}" r="4" fill="#2E8B57" stroke="white" stroke-width="2"/>
                                <text x="${x}" y="${chartHeight + 25}" text-anchor="middle" font-size="9" fill="#666">${point.date.split(',')[0].split('/')[0]}/${point.date.split(',')[0].split('/')[1]}</text>
                            `;
                        }).join('')}
                    </svg>
                </div>
            `;

            document.getElementById('chartContent').innerHTML = chartHTML;
        }

        // Update session summary with accordion functionality
        function updateSessions() {
            const sessionData = {};
            
            // Group data by session
            dashboardData.forEach(record => {
                if (!sessionData[record.sessionId]) {
                    sessionData[record.sessionId] = {
                        date: record.date,
                        sessionId: record.sessionId,
                        distances: {},
                        sets: []
                    };
                }
                
                if (!sessionData[record.sessionId].distances[record.distance]) {
                    sessionData[record.sessionId].distances[record.distance] = {
                        makes: 0,
                        attempts: 0,
                        sets: 0
                    };
                }
                
                sessionData[record.sessionId].distances[record.distance].makes += record.makes;
                sessionData[record.sessionId].distances[record.distance].attempts += record.puttsPerSet;
                sessionData[record.sessionId].distances[record.distance].sets += 1;
                
                // Add individual set data
                sessionData[record.sessionId].sets.push({
                    distance: record.distance,
                    makes: record.makes,
                    attempts: record.puttsPerSet,
                    percentage: record.percentage
                });
            });

            const sessions = Object.values(sessionData).sort((a, b) => new Date(b.date) - new Date(a.date));

            let sessionHTML = '';
            sessions.slice(0, 10).forEach(session => {
                const isExpanded = expandedSessions.has(session.sessionId);
                
                // Calculate summary for each distance
                const distanceSummary = Object.entries(session.distances).map(([dist, data]) => {
                    const percentage = (data.makes / data.attempts * 100).toFixed(0);
                    return `${dist}ft: ${percentage}% | ${data.sets} sets | ${data.attempts} putts`;
                }).join(' | ');

                sessionHTML += `
                    <div class="session-item ${isExpanded ? 'expanded' : ''}" data-session-id="${session.sessionId}">
                        <div class="session-header" onclick="toggleSession('${session.sessionId}')">
                            <div class="session-info-dash">
                                <div class="session-date">${session.date}</div>
                                <div class="session-details">${distanceSummary}</div>
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="session-sets">
                            ${session.sets.map((set, index) => `
                                <div class="set-item">
                                    <span class="set-number">Set ${index + 1} (${set.distance}ft):</span>
                                    <span class="set-result">${set.makes}/${set.attempts} (${set.percentage}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('sessionSummary').innerHTML = sessionHTML || '<div class="no-data">No sessions yet</div>';
        }

        // Toggle session expansion
        function toggleSession(sessionId) {
            if (expandedSessions.has(sessionId)) {
                expandedSessions.delete(sessionId);
            } else {
                expandedSessions.add(sessionId);
            }
            updateSessions();
        }

        function startSession() {
            if (!currentUser) {
                showMessage('Please select a user first', 'error');
                return;
            }

            if (!selectedSetupDistance) {
                showMessage('Please select a distance', 'error');
                return;
            }

            const puttsPerSet = document.getElementById('puttsPerSet').value;

            if (!puttsPerSet) {
                showMessage('Please enter putts per set', 'error');
                return;
            }

            currentSessionData = {
                distance: selectedSetupDistance,
                puttsPerSet: parseInt(puttsPerSet),
                sessionId: generateSessionId(),
                sets: [],
                isActive: true
            };

            document.getElementById('currentDistance').textContent = selectedSetupDistance;
            document.getElementById('currentPutts').textContent = puttsPerSet;
            document.getElementById('currentUser').textContent = currentUser;

            // Hide setup section and show active session content
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('activeSessionContent').classList.remove('hidden');

            updatePresetButtons(parseInt(puttsPerSet));

            showMessage(`Session started! ${selectedSetupDistance}ft, ${puttsPerSet} putts per set`, 'success');
        }

        function updatePresetButtons(maxPutts) {
            const container = document.getElementById('presetButtons');
            container.innerHTML = '';
            
            for (let i = 0; i <= Math.min(maxPutts, 10); i++) {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = i;
                btn.addEventListener('click', () => setMakes(i));
                container.appendChild(btn);
            }
        }

        function setMakes(makes) {
            document.getElementById('makes').value = makes;
        }

        function logSet() {
            if (!currentSessionData.isActive) {
                showMessage('Please start a session first', 'error');
                return;
            }

            const makes = parseInt(document.getElementById('makes').value);
            
            if (isNaN(makes) || makes < 0 || makes > currentSessionData.puttsPerSet) {
                showMessage(`Makes must be between 0 and ${currentSessionData.puttsPerSet}`, 'error');
                return;
            }

            const setData = {
                makes: makes,
                attempts: currentSessionData.puttsPerSet,
                percentage: (makes / currentSessionData.puttsPerSet * 100).toFixed(1),
                timestamp: new Date().toISOString()
            };

            currentSessionData.sets.push(setData);
            saveToLocalData(setData);
            updateSessionStats();
            document.getElementById('makes').value = '';
        }

        async function saveToLocalData(setData) {
            const record = {
                "Session ID": currentSessionData.sessionId,
                "User": currentUser,
                "Distance": currentSessionData.distance,
                "Putts Per Set": currentSessionData.puttsPerSet,
                "Makes": setData.makes,
                "Date": new Date().toLocaleString('en-US'),
                "Status": "Completed",
                "Make Percentage": parseFloat(setData.percentage)
            };

            if (isOnline) {
                try {
                    await saveToAirtable(record);
                    showMessage(`Set saved! ${setData.makes}/${currentSessionData.puttsPerSet} (${setData.percentage}%)`, 'success');
                } catch (error) {
                    console.error('Error saving to Airtable:', error);
                    saveOfflineData(record);
                    showMessage(`Saved offline! ${setData.makes}/${currentSessionData.puttsPerSet} (${setData.percentage}%)`, 'success');
                }
            } else {
                saveOfflineData(record);
                showMessage(`Saved offline! ${setData.makes}/${currentSessionData.puttsPerSet} (${setData.percentage}%)`, 'success');
            }
        }

        async function saveToAirtable(record) {
            const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${AIRTABLE_CONFIG.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    records: [{
                        fields: record
                    }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Airtable API error: ${JSON.stringify(errorData)}`);
            }

            return await response.json();
        }

        function updateSessionStats() {
            const totalSets = currentSessionData.sets.length;
            const totalAttempts = totalSets * currentSessionData.puttsPerSet;
            const totalMakes = currentSessionData.sets.reduce((sum, set) => sum + set.makes, 0);
            const sessionAverage = totalAttempts > 0 ? (totalMakes / totalAttempts * 100).toFixed(1) : 0;

            document.getElementById('setsCount').textContent = totalSets;
            document.getElementById('totalAttempts').textContent = totalAttempts;
            document.getElementById('totalMakes').textContent = totalMakes;
            document.getElementById('sessionAverage').textContent = sessionAverage + '%';
        }

        function showEndSessionConfirm() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function cancelEndSession() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function confirmEndSession() {
            currentSessionData.isActive = false;
            selectedSetupDistance = null;
            
            // Reset distance selection buttons
            document.querySelectorAll('.distance-select-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Show setup section and hide active session content
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('activeSessionContent').classList.add('hidden');
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('startSessionBtn').disabled = true;

            showMessage('Session ended. Set up a new session above.', 'success');
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return; // Exit if message area doesn't exist
            
            const messageClass = type === 'error' ? 'error-message' : 'success-message';
            
            messageArea.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            setTimeout(() => {
                if (messageArea) {
                    messageArea.innerHTML = '';
                }
            }, 3000);
        }
    </script>
</body>
</html>
